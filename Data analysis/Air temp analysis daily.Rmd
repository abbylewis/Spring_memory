---
title: "Air temp analysis"
author: "Abby Lewis"
date: "2023-05-22"
output: html_document
---

This file analyzes the effect of variation in air temperature on hypolimnetic temperature and DO.

Table of contents: Step 1: Load packages and data Step 2: Generate temp anomaly summary fig Step 3: Analyze the effect of monthly air temperature on hypolimnetic DO, VHOD, and temp dynamics

Step 1: Load packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(mosaic)
library(ggallin)
library(ppcor)
library(multcompView)
library(ggpubr)
library(viridis)
library(MASS)
library(see)
source("monthly_correlations.R")

#Load saved data
with_temp = read.csv("../Compiled data/All_data_annual AF.csv")
lat_long <- read.csv("https://pasta.lternet.edu/package/data/eml/edi/1530/1/fadd3eaa25b5fdd1fc4efba70e660579")
daily_temp_raw <- read.csv("../Compiled data/historical_temp_output_era5_daily.csv")
daily_temp <- daily_temp_raw %>%
  mutate(Date = as.Date(Date),
         Date = ifelse(Lat < 0, Date - months(6), Date),
         Date = as.Date(Date, origin = "1970-01-01")) %>%
  dplyr::select(-Lat, -Lon) %>%
  mutate(Year = year(Date))
rm(daily_temp_raw)

# Make a directory for Figures if there isn't one
if (!dir.exists("../Figures")){dir.create("../Figs")}
```

Step 4: Rolling means

```{r}
many_lake_temp_sum <- with_temp %>%
  left_join(daily_temp) %>%
  mutate(doy = yday(Date),
         Year = ifelse(month(Date) >= 9, Year + 1, Year)) %>%
  group_by(LakeID) %>%
  arrange(Date) %>%
  mutate(Temp_C = zoo::rollmean(Temp_C, 50, align = "right", fill = NA))
# ---

do_temp_roll <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations_doy("DO_mgL_HYPO", "Temp_C", "hypolimnetic DO", alpha = 0.001)

temp_demand_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "Temp_C", 
                                    "Summer VHOD ", alpha = 0.001)

epi_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_EPI", "Temp_C", 
                                    "Summer epi. temperature ", alpha = 0.001)

epi_do_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "DO_mgL_EPI", "Temp_C", 
                                    "Summer epi. temperature ", alpha = 0.001)

#I don't think worth including chl-a. Potentially a negative correlation in summer, no real other patterns
#epi_chla_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "Chla_ugL_EPI", "Temp_C", 
#                                    "Summer epi. chl-a ", alpha = 0.001)
# I've also tried EPI TP and HYPO TP, no clear patterns

hypo_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_HYPO", "Temp_C", 
                                    "Summer hypo. temperature ", alpha = 0.001)

alpha <- 0.001

all <- do_temp_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  full_join(epi_do_roll %>%
              mutate(var = "Summer epi. DO")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(temp_demand_roll %>% 
              mutate(var = "Summer VHOD")) %>%
  mutate(sig = ifelse(p < alpha, T, F))

write.csv(all, "../Compiled data/Correlations - 30 day rolling mean.csv", row.names = F)
```

Plots of rolling means

```{r}
all <- read.csv("../Compiled data/Correlations - 30 day rolling mean.csv")

group_fun <- function(sig) {
  group <- rep(1, length(sig))
  for (i in 2:length(sig)) {
    if(sig[i] == sig[i - 1]) {
      group[i] <- group[i - 1]
    } else {
      group[i] <- group[i - 1] + 1
    }
  }
  return(group)
}

all_plot <- all %>%
  group_by(var) %>%
  mutate(n = max(n), #Some lakes are missing from January because our air temp only goes back to 1980
         var = paste0(var, " (n = ",n,")")) %>%
  group_by(var, doy, sig) %>%
  summarise(mean = mean(monthly_correlation, na.rm = T),
            sd = sd(monthly_correlation, na.rm = T)) 

all_plot$group <- 1
for(i in 1:length(unique(all_plot$var))){
  all_plot$group[all_plot$var == unique(all_plot$var)[i]] <- group_fun(all_plot$sig[all_plot$var == unique(all_plot$var)[i]])
}

empty_df <- data.frame(var = unique(all_plot$var)) %>%
  filter(!var == "Summer epi. DO (n = 397)") %>%
  mutate(var = factor(var, levels = c("Summer epi. temperature (n = 413)",
                                      "Summer hypo. temperature (n = 368)",
                                      "Summer VHOD (n = 194)",
                                      "Summer hypo. DO (n = 286)")))

all_plot1 <- all_plot %>%
  mutate(DateTime = as.Date("2022-01-01") + days(doy))

all_plot2 <- all_plot %>%
  ungroup() %>%
  mutate(DateTime = as.Date("2022-01-01") + days(doy) + hours(23) + minutes(59),
         mean = ifelse(!is.na(lead(var)) & lead(var) == var, lead(mean), mean), #to get smooth lines
         sd = ifelse(lead(var) == var, lead(sd), sd))

colored_sd <- all_plot1 %>%
  full_join(all_plot2) %>%
  filter(!var == "Summer epi. DO (n = 397)") %>%
  mutate(var = factor(var, levels = c("Summer epi. temperature (n = 413)",
                                      "Summer hypo. temperature (n = 368)",
                                      "Summer VHOD (n = 194)",
                                      "Summer hypo. DO (n = 286)"))) %>%
  ggplot() + 
  #geom_rect(aes(xmin = as_datetime("2022-03-01"), 
  #              xmax = as_datetime("2022-05-31"), 
  #              ymin = -Inf, ymax = Inf), 
  #              fill = "grey80", alpha = 0.3, 
  #          data = empty_df) +
  #geom_rect(aes(xmin = as_datetime("2022-03-01") + days(30), 
  #              xmax = as_datetime("2022-05-31") + days(30), 
  #              ymin = -Inf, ymax = Inf), 
  #              fill = "grey80", alpha = 0.3, 
  #          data = empty_df) +
  #geom_rect(aes(xmin = as_datetime("2022-07-01"), xmax = as_datetime("2022-08-31"), 
  #              ymin = -Inf, ymax = Inf), 
  #              fill = "grey80", alpha = 0.3, 
  #          data = empty_df) +
  #geom_rect(aes(xmin = as_datetime("2022-07-01") + days(30), 
  #              xmax = as_datetime("2022-08-31") + days(30), 
  #              ymin = -Inf, ymax = Inf), 
  #              fill = "grey80", alpha = 0.3, 
  #          data = empty_df) +
  geom_hline(yintercept=0)+
  geom_vline(xintercept = as_datetime("2022-04-21"), color = "grey50", lty = "dashed")+
  geom_ribbon(aes(x = DateTime, 
                  ymin = mean - sd, ymax = mean + sd,
                  fill = sig, group = group),
              alpha = 0.5) +
  geom_line(aes(x = DateTime, y = mean)) +
  #geom_text(aes(x = as_datetime("2022-03-15") , y = 0.8, label = paste0("Spring")), 
  #          size = 3, color = "grey30",
  #          data = empty_df) +
  #geom_text(aes(x = as_datetime("2022-08-01") , y = 0.8, label = paste0("Summer")), 
  #          size = 3, color = "grey30",
  #          data = empty_df) +
  xlab("Air temperature date \n(right-aligned 30-day rolling mean)")+
  ylab("Correlation")+
  theme_bw()+
  scale_fill_manual(values = c("grey40","#0FA9E6"))+
  labs(fill = paste0("p < ",alpha)) +
  facet_wrap(~var, ncol = 2) 

jpeg("../Figures/Monthly correlations - all daily roll mean sd.jpg", width = 8, height = 5, res = 300, units = "in")
colored_sd
dev.off()
```

```{r}
all_plot1 %>%
  pivot_longer(cols = c(mean, sd)) %>%
  ggplot(aes(x = DateTime, y = value, color = name)) +
  geom_line()+
  facet_grid(cols = vars(var), rows = vars(name), scales = "free")

all_plot1 %>%
  group_by(var) %>%
  summarize(max = max(mean, na.rm = T),
            min = min(mean, na.rm = T),
            max_doy = doy[mean == max],
            min_doy = doy[mean == min]) %>%
  mutate(max_doy = as.Date("2022-01-01") + days(max_doy),
         min_doy = as.Date("2022-01-01") + days(min_doy))

dates_to_plot <- do_temp_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(temp_demand_roll %>% 
              mutate(var = "Summer VHOD")) %>%
  group_by(var, LakeID) %>%
  summarize(max = max(monthly_correlation, na.rm = T),
            min = min(monthly_correlation, na.rm = T),
            max_doy = doy[which.max(monthly_correlation)],
            min_doy = doy[which.min(monthly_correlation)]) 

dates_to_plot %>%
  mutate(max_doy = ifelse(var == "Summer hypo. DO", min_doy, max_doy)) %>%
  ggplot(aes(x = as.Date("2022-01-01") + max_doy))+
  geom_histogram(binwidth = 7)+
  facet_wrap(~var, scales = "free_y")+
  xlab("Date of strongest correlation")+
  theme_bw()

library(ggridges)
dates_to_plot %>%
  left_join(lat_long) %>%
  filter(abs(Latitude_DD) > 30) %>%
  mutate(max_doy = ifelse(var == "Summer hypo. DO", min_doy, max_doy)) %>%
  ggplot(aes(x = as.Date("2022-01-01") + max_doy, 
             y = var))+
  geom_density_ridges(
      quantile_lines = TRUE,
      jittered_points = TRUE,
      alpha = 1,
      point_alpha = 1,
      fill = "grey96",
      point_color = "grey50",
      point_fill = "white",
      #aes(point_fill = Var),
      point_shape = 21,
      scale=0.9)+
  stat_density_ridges(
      quantile_lines = TRUE,
      geom = "density_ridges_gradient", calc_ecdf = TRUE,aes(fill = factor(after_stat(quantile))),
      scale=0.9)+
  xlab("Date of strongest correlation")+
  theme_bw()+
  xlim(as.Date(c("2022-01-01", "2022-08-31")))+
  scale_fill_viridis_d(alpha=0.1)+
  theme(legend.position = "none",
        axis.text.y = element_text(vjust = 0),
        axis.title.y = element_blank())

dates_to_plot %>%
  filter(var == "Summer hypo. temperature") %>%
  summarize(median(max_doy))
```

```{r}
sp <- yday(c("2022-03-01", "2022-05-31"))
su <- yday(c("2022-07-01", "2022-08-31"))
dates_to_plot <- do_temp_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(temp_demand_roll %>% 
              mutate(var = "Summer VHOD")) %>%
  mutate(season = ifelse(doy >= sp[1] & doy <= sp[2], "spring", 
                         ifelse(doy >= su[1] & doy <= su[2], "summer", NA))) %>%
  filter(!is.na(season)) %>%
  group_by(var, LakeID, season) %>%
  summarize(max_doy = doy[which.max(abs(monthly_correlation))]) 

dates_to_plot %>%
  left_join(lat_long) %>%
  #filter(abs(Latitude_DD) > 30) %>%
  ggplot(aes(x = as.Date("2022-01-01") + max_doy))+
  geom_histogram(binwidth = 2)+
  xlab("Date of strongest correlation")+
  theme_bw() +
  facet_grid(cols = vars(season), rows = vars(var), scales = "free_x")
```

```{r}
sp <- yday(c("2022-03-01", "2022-05-31"))
su <- yday(c("2022-07-01", "2022-08-31"))
memory <- all %>% 
  filter(!var == "Summer epi. DO") %>%
  mutate(var = factor(var, levels = c("Summer epi. temperature",
                                      "Summer hypo. temperature",
                                      "Summer VHOD",
                                      "Summer hypo. DO"),
                      labels = c("Summer\nepi. temperature",
                                      "Summer\nhypo. temperature",
                                      "Summer\nVHOD",
                                      "Summer\nhypo. DO")),
         season = ifelse(doy >= sp[1] & doy <= sp[2], "spring", 
                         ifelse(doy >= su[1] & doy <= su[2], "summer", NA))) %>%
  group_by(var) %>%
  mutate(p = wilcox.test(monthly_correlation)$p.value) %>%
  filter(!is.na(season)) %>%
  group_by(LakeID, var, season, p) %>%
  summarize(max = max(abs(monthly_correlation))) %>%
  pivot_wider(names_from = season, values_from = max) %>%
  mutate(M = (spring - summer)) 

memory_plot <- memory %>%
  ggplot(aes(x = var, y = M, color = p < 0.001))+
  geom_hline(yintercept = 0)+
  geom_boxplot()+
  ylab("Relative correlation with spring vs. summer air temp")+
  theme_bw() +
  theme(axis.title.x = element_blank())

jpeg("../Figures/Monthly correlations - sum.jpg", width = 6, height = 4, res = 300, units = "in")
memory_plot
dev.off()

summer_avgs = read.csv("../Compiled data/summer_averages_wi.csv")%>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

mean_temps <- with_temp %>%
  mutate(spring_temp = (temp_mar + temp_apr + temp_may)/3,
         summer_temp = (temp_july + temp_aug)/2) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            summer_temp = mean(summer_temp, na.rm = T))

memory %>%
  left_join(summer_avgs) %>%
  ggplot(aes(x = buoyancy_freq, y = M))+
  geom_hline(yintercept = 0)+
  geom_point()+
  geom_smooth(method = "lm")+
  ylab("Relative correlation with spring vs. summer air temp")+
  theme_bw() +
  facet_wrap(~var)

source("lmer_functions.R")
mem_lm <- memory %>%
  left_join(summer_avgs) %>%
  left_join(mean_temps) %>%
  left_join(lat_long) %>%
  mutate(log_SA = log(SurfaceArea_ha),
         log_max_depth = log(MaximumDepth_m)) %>%
  pivot_wider(names_from = var, values_from = M) %>%
  rename(epi_temp = `Summer\nepi. temperature`,
         hypo_temp = `Summer\nhypo. temperature`,
         hypo_do = `Summer\nhypo. DO`,
         vhod = `Summer\nVHOD`)

responses <- c("epi_temp")
potential_drivers <- c("log_SA", 
                       "log_max_depth", 
                       "Latitude_DD",
                       "buoyancy_freq",
                       "summer_temp",
                       "spring_temp"
                      )
aic_calculator_lm(mem_lm,responses,potential_drivers, interaction = "+")
selected_drivers <- c("Latitude_DD")
std_data <-standardize_data(mem_lm,responses,selected_drivers)
mod_lm <- lm(epi_temp~Latitude_DD, data = std_data) 
summary(mod_lm)
plot_effects_lm(mod_lm,"Spring memory effect - summer epi. temperature") 
mem_lm %>%
  ggplot(aes(x = SurfaceArea_ha, y = hypo_temp, color = buoyancy_freq))+
  scale_x_log10()+
  geom_smooth(method = "lm")+
  scale_color_viridis_c()+
  geom_point()

responses <- c("hypo_temp")
potential_drivers <- c("log_SA", 
                       "log_max_depth", 
                       #"Latitude_DD",
                       "buoyancy_freq"#,
                       #"summer_temp",
                       #"spring_temp"
                      )
aic_calculator_lm_mult(mem_lm,responses,potential_drivers, interaction = "*")
selected_drivers <- c("log_SA", "buoyancy_freq", "summer_temp")
std_data <-standardize_data(mem_lm,responses,selected_drivers)
mod_lm <- lm(hypo_temp~log_SA*buoyancy_freq*summer_temp, data = std_data) 
summary(mod_lm)
MuMIn::AICc(mod_lm) #need to also include non-interaction models in the AICc selection
plot_effects_lm(mod_lm,"Spring memory effect - summer hypo. temperature") 

mem_lm_df <- mem_lm%>%
    ungroup()%>%
    dplyr::select(all_of(c(potential_drivers,responses,"LakeID")))%>%
    filter(if_all(where(is.numeric),is.finite))%>%
    mutate(across(-LakeID,zscore))
fm1 <- lm(hypo_temp ~ log_SA*log_max_depth*buoyancy_freq, 
          data = mem_lm_df,
          na.action = "na.fail")
dd <- MuMIn::dredge(fm1)
subset(dd, delta < 2)

responses <- c("hypo_do")
potential_drivers <- c("log_SA", 
                       "log_max_depth", 
                       "Latitude_DD",
                       "buoyancy_freq",
                       "summer_temp",
                       "spring_temp"
                      )
aic_calculator_lm(mem_lm,responses,potential_drivers, interaction = "+")
selected_drivers <- c("log_SA", "buoyancy_freq", "summer_temp")
std_data <-standardize_data(mem_lm,responses,selected_drivers)
mod_lm <- lm(hypo_do~log_SA+buoyancy_freq+summer_temp, data = std_data) 
summary(mod_lm)
plot_effects_lm(mod_lm,"Spring memory effect - summer hypo. DO") 

responses <- c("vhod")
potential_drivers <- c("log_SA", 
                       "log_max_depth", 
                       "Latitude_DD",
                       "buoyancy_freq",
                       "summer_temp",
                       "spring_temp"
                      )
aic_calculator_lm(mem_lm,responses,potential_drivers, interaction = "+")
selected_drivers <- c("buoyancy_freq")
std_data <-standardize_data(mem_lm,responses,selected_drivers)
mod_lm <- lm(vhod~buoyancy_freq, data = std_data) 
summary(mod_lm)
```


```{r}
many_lake_temp_sum <- with_temp %>%
  left_join(daily_temp) %>%
  mutate(doy = yday(Date),
         Year = ifelse(month(Date) >= 9, Year + 1, Year)) %>%
  group_by(LakeID) %>%
  arrange(Date) %>%
  mutate(Temp_C = zoo::rollmean(Temp_C, 30, align = "right", fill = NA))

jpeg("../Figures/Summer otsego.jpg", res = 300, width = 4, height = 4, units = "in")
many_lake_temp_sum %>%
  filter(LakeID == "124",
         doy == 225) %>%
  ggplot(aes(x = Temp_C, y = Temp_C_EPI))+
  geom_point()+
  xlab("Mean air temperature July 15 - August 14")+
  ggtitle("Otsego")+
  ylab("Summer epilimnetic temperature")+
  theme_bw()
dev.off()

jpeg("../Figures/Winter otsego.jpg", res = 300, width = 4, height = 4, units = "in")
many_lake_temp_sum %>%
  filter(LakeID == "124",
         doy == 59) %>%
  ggplot(aes(x = Temp_C, y = Temp_C_EPI))+
  geom_point()+
  xlab("Mean air temperature March 1 - March 30")+
  ggtitle("Otsego")+
  ylab("Summer epilimnetic temperature")+
  theme_bw()
dev.off()

jpeg("../Figures/Summer all.jpg", res = 300, width = 4, height = 4, units = "in")
epi_temp_roll %>%
  filter(doy == 225) %>%
  ggplot(aes(x = monthly_correlation, y = doy))+
  geom_density_ridges(
      quantile_lines = TRUE,
      jittered_points = TRUE,
      alpha = 1,
      point_alpha = 1,
      fill = "grey96",
      point_color = "grey50",
      point_fill = "white",
      #aes(point_fill = Var),
      point_shape = 21,
      scale=0.9)+
  stat_density_ridges(
      quantile_lines = TRUE,
      geom = "density_ridges", calc_ecdf = TRUE,
      scale=0.9, alpha = 0)+
  xlab("Spearman's correlation")+
  ylab("Density")+
  theme_bw()+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),)+
  ggtitle("July 15 - August 14 air temp.")
dev.off()

jpeg("../Figures/Winter all.jpg", res = 300, width = 4, height = 4, units = "in")
epi_temp_roll %>%
  filter(doy == 58) %>%
  ggplot(aes(x = monthly_correlation, y = doy))+
  geom_density_ridges(
      quantile_lines = TRUE,
      jittered_points = TRUE,
      alpha = 1,
      point_alpha = 1,
      fill = "grey96",
      point_color = "grey50",
      point_fill = "white",
      #aes(point_fill = Var),
      point_shape = 21,
      scale=0.9)+
  stat_density_ridges(
      quantile_lines = TRUE,
      geom = "density_ridges", calc_ecdf = TRUE,
      scale=0.9, alpha = 0)+
  xlab("Spearman's correlation")+
  ylab("Density")+
  theme_bw()+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),)+
  ggtitle("March 1 - March 30 air temp.")
dev.off()
```


