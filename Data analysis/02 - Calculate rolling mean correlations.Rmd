---
title: "Calculate correlations"
author: "Abby Lewis"
date: "2023-05-22"
output: html_document
---

This file calculates the correlation between mean air temperature and surface- and bottom-water temperature and dissolved oxygen.

Table of contents:

- Step 1: Load packages and data
- Step 2: Calculate and export 30-day rolling mean correlations
- Step 3: Re-run with 10-day window
- Step 4: Re-run with 50-day window

Step 1: Load packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(rMR) #for calculating DO % saturation
source("monthly_correlations.R")

#Load saved data
with_temp = read.csv("../Compiled data/All_data_annual.csv")
lat_long <- read.csv("https://pasta.lternet.edu/package/data/eml/edi/1530/1/fadd3eaa25b5fdd1fc4efba70e660579")

# Make a directory for Figures if there isn't one
if (!dir.exists("../Figures")){dir.create("../Figures")}
```

Step 2: Calculate and export rolling means (30-day)

```{r}
daily_temp_raw <- read.csv("../Compiled data/historical_temp_output_era5_daily.csv")
daily_temp <- daily_temp_raw %>%
  mutate(Date = as.Date(Date),
         Date = ifelse(Lat < 0, Date - months(6), Date),
         Date = as.Date(Date, origin = "1970-01-01")) %>%
  dplyr::select(-Lat, -Lon) %>%
  mutate(Year = year(Date))
rm(daily_temp_raw)

many_lake_temp_sum <- with_temp %>%
  left_join(daily_temp) %>%
  mutate(doy = yday(Date),
         Year = ifelse(month(Date) >= 9, Year + 1, Year),
         #Calculate DO saturation
         DO_sat_EPI = ifelse(is.na(DO_sat_EPI),
                             rMR::DO.saturation(DO_mgL_EPI, 
                                                Temp_C_EPI, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_EPI),
         DO_sat_HYPO = ifelse(is.na(DO_sat_HYPO),
                             rMR::DO.saturation(DO_mgL_HYPO, 
                                                Temp_C_HYPO, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_HYPO)) %>%
  group_by(LakeID) %>%
  arrange(Date) %>%
  mutate(Temp_C = zoo::rollmean(Temp_C, 30, align = "right", fill = NA))

# ---

hypo_do_roll <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T) < 1,"yes","no")) %>%
  filter(hypoxic=="no") %>%
  monthly_correlations_doy("DO_mgL_HYPO", "Temp_C", "hypolimnetic DO", alpha = 0.001)

hypo_demand_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "Temp_C", 
                                    "Summer VHOD ", alpha = 0.001)

epi_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_EPI", "Temp_C", 
                                    "Summer epi. temperature ", alpha = 0.001)

#epi_do_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_mgL_EPI", "Temp_C", 
#                                    "Summer epi. DO ", alpha = 0.001)

#epi_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_EPI", "Temp_C", 
#                                    "Summer epi. DO (saturation) ", alpha = 0.001)

#hypo_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_HYPO", "Temp_C", 
#                                    "Summer hypo. DO (saturation) ", alpha = 0.001)

hypo_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_HYPO", "Temp_C", 
                                    "Summer hypo. temperature ", alpha = 0.001)

all <- hypo_do_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  #full_join(epi_do_roll %>%
  #            mutate(var = "Summer epi. DO")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(hypo_demand_roll %>% 
              mutate(var = "Summer VHOD")) #%>%
  #full_join(epi_do_sat_roll %>%
  #            mutate(var = "Summer epi. DO sat")) %>%
  #full_join(hypo_do_sat_roll %>%
  #            mutate(var = "Summer hypo. DO sat"))

write.csv(all, "../Compiled data/Correlations - 30 day rolling mean.csv", row.names = F)
```

Step 3: Re-run with 10-day window

```{r}
many_lake_temp_sum <- with_temp %>%
  left_join(daily_temp) %>%
  mutate(doy = yday(Date),
         Year = ifelse(month(Date) >= 9, Year + 1, Year),
         #Calculate DO saturation
         DO_sat_EPI = ifelse(is.na(DO_sat_EPI),
                             rMR::DO.saturation(DO_mgL_EPI, 
                                                Temp_C_EPI, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_EPI),
         DO_sat_HYPO = ifelse(is.na(DO_sat_HYPO),
                             rMR::DO.saturation(DO_mgL_HYPO, 
                                                Temp_C_HYPO, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_HYPO)) %>%
  group_by(LakeID) %>%
  arrange(Date) %>%
  mutate(Temp_C = zoo::rollmean(Temp_C, 10, align = "right", fill = NA))

# ---

hypo_do_roll <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T) < 1,"yes","no")) %>%
  filter(hypoxic=="no") %>%
  monthly_correlations_doy("DO_mgL_HYPO", "Temp_C", "hypolimnetic DO", alpha = 0.001)

hypo_demand_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "Temp_C", 
                                    "Summer VHOD ", alpha = 0.001)

epi_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_EPI", "Temp_C", 
                                    "Summer epi. temperature ", alpha = 0.001)

#epi_do_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_mgL_EPI", "Temp_C", 
#                                    "Summer epi. DO ", alpha = 0.001)

#epi_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_EPI", "Temp_C", 
#                                    "Summer epi. DO (saturation) ", alpha = 0.001)

#hypo_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_HYPO", "Temp_C", 
#                                    "Summer hypo. DO (saturation) ", alpha = 0.001)

hypo_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_HYPO", "Temp_C", 
                                    "Summer hypo. temperature ", alpha = 0.001)

all <- hypo_do_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  #full_join(epi_do_roll %>%
  #            mutate(var = "Summer epi. DO")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(hypo_demand_roll %>% 
              mutate(var = "Summer VHOD")) #%>%
  #full_join(epi_do_sat_roll %>%
  #            mutate(var = "Summer epi. DO sat")) %>%
  #full_join(hypo_do_sat_roll %>%
  #            mutate(var = "Summer hypo. DO sat"))

write.csv(all, "../Compiled data/Correlations - 10 day rolling mean.csv", row.names = F)
```

Step 4: Re-run with 50-day window

```{r}
many_lake_temp_sum <- with_temp %>%
  left_join(daily_temp) %>%
  mutate(doy = yday(Date),
         Year = ifelse(month(Date) >= 9, Year + 1, Year),
         #Calculate DO saturation
         DO_sat_EPI = ifelse(is.na(DO_sat_EPI),
                             rMR::DO.saturation(DO_mgL_EPI, 
                                                Temp_C_EPI, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_EPI),
         DO_sat_HYPO = ifelse(is.na(DO_sat_HYPO),
                             rMR::DO.saturation(DO_mgL_HYPO, 
                                                Temp_C_HYPO, 
                                                elevation.m = Elevation_m,
                                                salinity = 0,
                                                salinity.units = "uS"),
                             DO_sat_HYPO)) %>%
  group_by(LakeID) %>%
  arrange(Date) %>%
  mutate(Temp_C = zoo::rollmean(Temp_C, 50, align = "right", fill = NA))

# ---

hypo_do_roll <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T) < 1,"yes","no")) %>%
  filter(hypoxic=="no") %>%
  monthly_correlations_doy("DO_mgL_HYPO", "Temp_C", "hypolimnetic DO", alpha = 0.001)

hypo_demand_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "Temp_C", 
                                    "Summer VHOD ", alpha = 0.001)

epi_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_EPI", "Temp_C", 
                                    "Summer epi. temperature ", alpha = 0.001)

#epi_do_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_mgL_EPI", "Temp_C", 
#                                    "Summer epi. DO ", alpha = 0.001)

#epi_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_EPI", "Temp_C", 
#                                    "Summer epi. DO (saturation) ", alpha = 0.001)

#hypo_do_sat_roll <- monthly_correlations_doy(many_lake_temp_sum, 
#                                    "DO_sat_HYPO", "Temp_C", 
#                                    "Summer hypo. DO (saturation) ", alpha = 0.001)

hypo_temp_roll <- monthly_correlations_doy(many_lake_temp_sum, 
                                    "Temp_C_HYPO", "Temp_C", 
                                    "Summer hypo. temperature ", alpha = 0.001)

all <- hypo_do_roll %>%
  mutate(var = "Summer hypo. DO") %>%
  full_join(epi_temp_roll %>%
              mutate(var = "Summer epi. temperature")) %>%
  #full_join(epi_do_roll %>%
  #            mutate(var = "Summer epi. DO")) %>%
  full_join(hypo_temp_roll %>%
              mutate(var = "Summer hypo. temperature")) %>%
  full_join(hypo_demand_roll %>% 
              mutate(var = "Summer VHOD")) #%>%
  #full_join(epi_do_sat_roll %>%
  #            mutate(var = "Summer epi. DO sat")) %>%
  #full_join(hypo_do_sat_roll %>%
  #            mutate(var = "Summer hypo. DO sat"))

write.csv(all, "../Compiled data/Correlations - 50 day rolling mean.csv", row.names = F)
```

