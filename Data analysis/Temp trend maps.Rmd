---
title: "Temp trend maps"
author: "Abby Lewis"
date: "2023-09-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(trend) #switched from open air 7 Nov 2023

# Make a directory for Figures if there isn't one
if (!dir.exists("../Figures")){dir.create("../Figs")}
```

```{r}
lat_long = read.csv("https://pasta-s.lternet.edu/package/data/eml/edi/1029/9/fadd3eaa25b5fdd1fc4efba70e660579")

climate_narr = read.csv("../Compiled data/historical_temp_output_narr.csv")
climate_jra55 = read.csv("../Compiled data/historical_temp_output_jra55.csv")
climate_era5 = read.csv("../Compiled data/historical_temp_output_era5.csv")
```

```{r}
sen_slope_climate <- function(df,var){
  df <- df %>%
    mutate(date = ymd_hms(paste(Year,"-01-01 00:00:00")))
  output = df %>%
    group_by(LakeID)%>%
    dplyr::summarize(n = n(),
                     trend = NA,
                     sig = NA,
                     min_year = NA,
                     max_year = NA)
  for(lake in unique(df$LakeID)){
      filt = df%>%
        filter(LakeID==lake)
      if(length(unique(filt$Year))>=5){
        sen = trend::sens.slope(filt[[var]])
        output$trend[output$LakeID==lake]<-sen$estimates[1]
        output$sig[output$LakeID==lake]<-sen$p.value[1]
        output$min_year[output$LakeID==lake]<-min(year(filt$date))
        output$max_year[output$LakeID==lake]<-max(year(filt$date))
      }
  }
  return(output)
}

sen_slope_months <- function(df, var, months = 1:12) {
  output <- sen_slope_climate(df%>%filter(Month == months[1]), var)%>%
    mutate(Month = months[1])
  
  if(length(months)>1){
    for (month in months[2:length(months)]) {
      output <- rbind(output, 
                      sen_slope_climate(df%>%filter(Month == month), var)%>%
                        mutate(Month = month)
    )
    }
  }
  
  # Save output only if all months were run
  if(length(months)==12){
    write.csv(output, paste0("../Compiled data/", 
                             deparse(substitute(df)), "_",
                             deparse(substitute(var)), ".csv"), 
              row.names = F)
  }
  
  return(output)
}

climate_narr_trends <- sen_slope_months(climate_narr %>% filter(Year >= 1980), 
                                        "Temp_C") #takes ~10 seconds
climate_jra55_trends <- sen_slope_months(climate_jra55 %>% filter(Year >= 1980), 
                                         "Temp_C")
climate_era5_trends <- sen_slope_months(climate_era5 %>% filter(Year >= 1980), 
                                        "Temp_C")
```

Map
```{r}
library(ggthemes)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
#remotes::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)
library(ggspatial)
library(viridis)
library(ggpubr)

all_trends <- climate_era5_trends %>% 
  mutate(Model = "ERA5",
         Month = factor(Month, 
                        levels = unique(Month), 
                        labels = month.abb[unique(Month)],
                        ordered = T))
min = min(all_trends$trend)*10
max = max(all_trends$trend)*10
abs_max = max(abs(c(min,max)))

for_states <- all_trends%>%
  left_join(lat_long)
states <- ne_states(returnclass = "sf",country = "United States of America")

plot_nh <- function(for_states){
  world <- ne_countries(scale = "medium", returnclass = "sf")
nh_map = ggplot(data = states) +
  geom_sf(fill = "grey98", color = "grey80", data = world) +
  geom_sf(fill = "white") +
  coord_sf(expand = FALSE, ylim = c(42, 47.5), xlim = c(-76,-67))+
  geom_point(data = for_states, 
             aes(Longitude_DD, Latitude_DD, fill = trend*10),
             shape = 21, color = "grey50", size = 2, alpha  =.5, stroke = .4)+
  theme_bw()+
  scale_fill_gradientn(name = "Air temperature trend\n(ºC/decade)",
                       colours = c("blue","white","red"),
                       limits = c(-abs_max, abs_max))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.background = element_rect(fill = "grey90"),
        panel.grid = element_blank(),
        legend.position = "bottom",
        strip.text = element_blank())+
  facet_grid(rows = vars(Month))
}

plot_wi <- function(for_states){
  wi_map = ggplot(data = states) +
  geom_sf(fill = "white") +
  coord_sf(expand = FALSE, ylim = c(42, 47.5), xlim = c(-93,-86.5))+
  geom_point(data = for_states, 
             aes(Longitude_DD, Latitude_DD, fill = trend*10),
             shape = 21, color = "grey50", size = 2, alpha  =.5, stroke = .4)+
  theme_minimal()+
  #scale_fill_viridis(name = "Air temperature trend\n(ºC/decade)",
  #                   limits = c(min,max), option = "H")+
  scale_fill_gradientn(name = "Air temperature trend\n(ºC/decade)",
                       colours = c("blue","white","red"),
                       limits = c(-abs_max, abs_max))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "grey90"),
        panel.grid = element_blank(),
        panel.border=element_rect(fill=NA, colour="black")) +
  facet_grid(rows = vars(Month), switch = "y")
  return(wi_map)
}

wi_half1 <- plot_wi(for_states %>% filter(Month %in% c(month.abb[seq(1, 12, by = 2)])))
wi_half2 <- plot_wi(for_states %>% filter(Month %in% c(month.abb[seq(2, 12, by = 2)])))
nh_half1 <- plot_nh(for_states %>% filter(Month %in% c(month.abb[seq(1, 12, by = 2)])))
nh_half2 <- plot_nh(for_states %>% filter(Month %in% c(month.abb[seq(2, 12, by = 2)])))
wi_spring <- plot_wi(for_states %>% 
                       filter(Month %in% c(month.abb[2:4]))%>%
                       mutate(Month = "Spring"))
wi_summer <- plot_wi(for_states %>% 
                       filter(Month %in% c(month.abb[7:8]))%>%
                       mutate(Month = "Summer"))
wi_annual <- plot_wi(for_states %>% 
                       mutate(Month = "Mean annual"))
nh_spring <- plot_nh(for_states %>% 
                       filter(Month %in% c(month.abb[2:4]))%>%
                       mutate(Month = "Spring"))
nh_summer <- plot_nh(for_states %>% 
                       filter(Month %in% c(month.abb[7:8]))%>%
                       mutate(Month = "Summer"))
nh_annual <- plot_nh(for_states %>% 
                       mutate(Month = "Mean annual"))

jpeg("../Figures/temperature_trends_wi_ne.jpeg", height = 6, width = 4.5, units = "in", res = 300)
ggarrange(wi_half1, nh_half1, plot_spacer(), wi_half2, nh_half2, 
          ncol = 5, nrow = 1, widths = c(1,1,0.1,1,1),
          common.legend = TRUE, legend = "bottom")
dev.off()

jpeg("../Figures/temperature_trends_wi_ne_sum.jpeg", height = 4.5, width = 3, units = "in", res = 300)
ggarrange(wi_spring, nh_spring, 
          wi_summer, nh_summer, 
          wi_annual, nh_annual,
          ncol = 2, nrow = 3,
          common.legend = TRUE, legend = "bottom")
dev.off()
```

