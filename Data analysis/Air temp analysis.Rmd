---
title: "Air temp analysis"
author: "Abby Lewis"
date: "2023-05-22"
output: html_document
---

This file analyzes the effect of variation in air temperature on hypolimnetic temperature and DO.

Table of contents: Step 1: Load packages and data Step 2: Generate temp anomaly summary fig Step 3: Analyze the effect of monthly air temperature on hypolimnetic DO, VHOD, and temp dynamics

Step 1: Load packages and data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(mosaic)
library(ggallin)
library(ppcor)
library(multcompView)
library(ggpubr)
library(viridis)
library(MASS)
library(see)
source("monthly_correlations.R")

#Load saved data
with_temp = read.csv("../Compiled data/All_data_annual AF.csv")
lat_long <- read.csv("https://pasta.lternet.edu/package/data/eml/edi/1530/1/fadd3eaa25b5fdd1fc4efba70e660579")

# Make a directory for Figures if there isn't one
if (!dir.exists("../Figures")){dir.create("../Figs")}
```

```{r}
cv <- function(x){sd(x, na.rm = T)/mean(x, na.rm = T)}
across_years <- with_temp %>%
  group_by(LakeID) %>%
  summarize(cv = cv(Temp_C_HYPO),
            sd = sd(Temp_C_HYPO)) %>%
  mutate(var = "CV of annual means (within lakes)")

across_lakes <- with_temp %>%
  group_by(Year) %>%
  summarize(cv = cv(Temp_C_HYPO),
            n = n()) %>%
  filter(n > 50) %>%
  mutate(var = "CV across all lakes (within years)")

full_with_thermo <- read.csv("../Compiled data/Stratified_period_data_with_thermo.csv")%>%
  mutate(Date=as.Date(Date))

within_year <- full_with_thermo %>%
  filter(Depth_m>hypo_depth) %>%
  group_by(Date, LakeID) %>%
  dplyr::summarize(Temp_C = mean(Temp_C, na.rm = T), #mean across all hypolimnetic depths
                   ) %>%
  mutate(Year= year(Date)) %>%
  filter(!is.na(Temp_C)) %>%
  group_by(LakeID, Year) %>%
  summarize(cv = cv(Temp_C),
            sd = sd(Temp_C, na.rm = T),
            n = n()) %>%
  filter(n > 5) %>%
  group_by(LakeID) %>%
  summarize(cv = median(cv, na.rm = T),
            sd = median(sd, na.rm = T)) %>%
  mutate(var = "CV within a lake-year\n(median at each lake)")

across_years %>%
  full_join(across_lakes) %>%
  full_join(within_year) %>%
  ggplot(aes(y = var, x = cv)) +
  geom_violin(draw_quantiles = c(0.25, 0.75),
              linetype = "dashed") +
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  theme(axis.title.y = element_blank())

across_years %>%
  dplyr::select(-sd) %>%
  full_join(within_year %>% dplyr::select(-sd)) %>%
  pivot_wider(names_from = var, values_from = cv) %>%
  ggplot(aes(x = `CV of annual means (within lakes)`, y = `CV within a lake-year\n(median at each lake)`)) +
  geom_point()+
  geom_smooth(method = "lm")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed")

across_years %>%
  dplyr::select(-cv) %>%
  full_join(within_year %>% dplyr::select(-cv)) %>%
  pivot_wider(names_from = var, values_from = sd) %>%
  ggplot(aes(x = `CV of annual means (within lakes)`, y = `CV within a lake-year\n(median at each lake)`)) +
  geom_point()+
  geom_smooth(method = "lm")+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed")

within_year %>%
  filter(sd > 4)

full_with_thermo %>%
  filter(Depth_m>hypo_depth) %>%
  filter(LakeID == "396")
```

Step 2: Generate temp anomaly summary fig

```{r}
zscore <- function(data, na.rm = T){(data-mean(data, na.rm = na.rm))/sd(data, na.rm = na.rm)}
do_anomaly_stat <- with_temp%>%
  group_by(LakeID)%>%
  mutate(hypo_do_anom = DO_mgL_HYPO-mean(DO_mgL_HYPO, na.rm = T),
         spr_temp = (temp_mar+temp_apr)/2,
         spr_temp_anom = spr_temp - mean(spr_temp, na.rm = T))

cor_data <- do_anomaly_stat%>%
  dplyr::select(hypo_do_anom,spr_temp_anom,Year)%>%
  na.omit()

length(unique(cor_data$LakeID))

pcor.test(cor_data$hypo_do_anom, cor_data$spr_temp_anom,cor_data$Year,method = "spearman")$estimate

do_air_sum <- do_anomaly_stat%>%
  filter(!is.na(spr_temp_anom),
         !is.na(hypo_do_anom))%>%
  group_by(LakeID)%>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO,na.rm = T)<1,"y","n"))%>%
  ungroup()%>%
  filter(hypoxic=="n")%>%
  mutate(temp_anom_sum = ifelse(spr_temp_anom>0.6,"> 0.6",
                                ifelse(spr_temp_anom<(-0.6),"< -0.6","between -0.6 \nand 0.6")),
         temp_anom_sum = factor(temp_anom_sum, levels = c("< -0.6", "between -0.6 \nand 0.6", "> 0.6")),
         do_anom_sum = ifelse(hypo_do_anom>0.2,"> 0.2",
                                ifelse(hypo_do_anom<(-0.2),"< -0.2","between -0.2 \nand 0.2")),
         do_anom_sum = factor(do_anom_sum, levels = c("> 0.2", "between -0.2 \nand 0.2", "< -0.2")))%>%
  group_by(temp_anom_sum)%>%
  mutate(n=n())

jpeg("../Figures/DO and air temp anomaly - spring.jpg", width = 5, height = 3, res = 300, units = "in")
do_air_sum%>%
  ggplot(aes(fill = do_anom_sum, x = temp_anom_sum))+
  geom_bar(position = "fill")+
  geom_hline(yintercept = .5, color = "grey80",lty = "dashed")+
  geom_text(aes(y = .9, label = paste0("n = ",n)), color = "grey50")+
  labs(fill="Hypolimnetic \nDO anomaly (mg/L)")+
  xlab("Spring air temperature anomaly (ÂºC)")+
  ylab("Percent of lake-years")+
  scale_y_continuous(labels = scales::percent)+
  theme_bw()+
  scale_fill_viridis(discrete=T, direction = -1)
dev.off()
```

Step 3: Analyze the effect of monthly air temperature on hypolimnetic DO, VHOD, and temp dynamics

```{r}
many_lake_temp_sum <- with_temp%>%
  pivot_longer(cols = contains("temp", ignore.case = F), names_to = "mon")%>%
  filter(!mon=="mean_temp")%>%
  mutate(mon = month(as.Date(paste0("2022-",substr(mon,6,8),"-01"), format = "%Y-%b-%d")),
         Year = ifelse(mon>=9,Year+1,Year))
# ---

jpeg("../Figures/DO and temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
do_temp <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations("DO_mgL_HYPO", "value", "hypolimnetic DO", alpha = 0.001)
do_temp
dev.off()

jpeg("../Figures/AF and temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
do_temp_af <- many_lake_temp_sum %>%
  mutate(oxic = ifelse(max(AF, na.rm = T) == 0, "yes", "no"))%>%
  filter(oxic == "no") %>%
  monthly_correlations("AF", "value", "anoxic factor", alpha = 0.001)
do_temp_af
dev.off()

jpeg("../Figures/Air and strat hypo temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
temp_temp <- monthly_correlations(many_lake_temp_sum,
                                  "Temp_C_HYPO", "value", 
                                  "hypolimnetic temperature", alpha = 0.001)
temp_temp
dev.off()

jpeg("../Figures/Demand and air temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
temp_demand <- monthly_correlations(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "value", 
                                    "VHOD", alpha = 0.001)
temp_demand
dev.off()

#Quick check to see if this shows up for TP --> not really
jpeg("../Figures/TP and air temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
temp_tp <- monthly_correlations(many_lake_temp_sum, 
                                    "TP_ugL_HYPO", "value", 
                                    "hypolimnetic TP", alpha = 0.05)
temp_tp
dev.off()

jpeg("../Figures/Monthly correlations.jpg", width = 5, height = 8, res = 300, units = "in")
ggarrange(temp_temp+theme(axis.title.x = element_blank()),
          temp_demand+theme(axis.title.x = element_blank()),
          do_temp,
          common.legend = T, legend = "bottom",nrow=3, labels = "auto", align = "hv")
dev.off()

jpeg("../Figures/Monthly correlations af.jpg", width = 5, height = 9, res = 300, units = "in")
ggarrange(temp_temp + theme(axis.title.x = element_blank()),
          temp_demand + theme(axis.title.x = element_blank()),
          do_temp + theme(axis.title.x = element_blank()),
          do_temp_af,
          common.legend = T, legend = "bottom", nrow=4, 
          labels = "auto", align = "hv")
dev.off()
```

Epi and hypo temp and DO

```{r}
jpeg("../Figures/DO and temp by month - EPI.jpg", width = 6, height = 4, res = 300, units = "in")
do_temp_epi <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_EPI, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations("DO_mgL_EPI", "value", "epilimnetic DO", alpha = 0.001)
do_temp_epi
dev.off()

jpeg("../Figures/Air and epi temp by month.jpg", width = 6, height = 4, res = 300, units = "in")
temp_temp_epi <- monthly_correlations(many_lake_temp_sum,
                                  "Temp_C_EPI", "value", 
                                  "epilimnetic temperature", alpha = 0.001)
temp_temp_epi
dev.off()

jpeg("../Figures/Monthly correlations - EPI.jpg", width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi+theme(axis.title.x = element_blank()),
          do_temp_epi,
          common.legend = T, legend = "bottom",nrow=2, labels = "auto", align = "hv")
dev.off()

jpeg("../Figures/Monthly correlations - EPI vs HYPO.jpg", width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi + theme(axis.title.x = element_blank()),
          temp_temp,
          common.legend = T, legend = "bottom",nrow=2, labels = "auto", align = "hv")
dev.off()
```

AGU figures

```{r}
temp_temp_epi_agu <- monthly_correlations_talk(many_lake_temp_sum,
                                  "Temp_C_EPI", "value", 
                                  "Summer epi. temperature ", alpha = 0.001,
                                  highlight = c(6.5, 8.5))

temp_temp_agu <- monthly_correlations_talk(many_lake_temp_sum,
                                  "Temp_C_HYPO", "value", 
                                  "Summer hypo. temperature ", alpha = 0.001,
                                  highlight = c(1.5, 4.5))

jpeg("../Figures/Monthly correlations - EPI vs HYPO AGU.jpg", 
     width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_agu + 
            theme(axis.title.x = element_blank()),
          temp_temp_agu,
          common.legend = T, legend = "bottom",nrow=2, align = "hv")
dev.off()

temp_temp_epi_agu_aug <- monthly_correlations_talk_aug(many_lake_temp_sum,
                                  "Temp_C_EPI", "value", 
                                  "surface-water temperature", alpha = 0.001)

temp_temp_agu_aug <- monthly_correlations_talk_aug(many_lake_temp_sum,
                                  "Temp_C_HYPO", "value", 
                                  "bottom-water temperature", alpha = 0.001)

temp_temp_agu_spring_summer <- monthly_correlations_spring_summer(many_lake_temp_sum,
                                  "Temp_C_HYPO", "value", 
                                  "bottom-water temperature", alpha = 0.001)

temp_temp_epi_agu_spring_summer <- monthly_correlations_spring_summer(many_lake_temp_sum,
                                  "Temp_C_EPI", "value", 
                                  "bottom-water temperature", alpha = 0.001)

jpeg("../Figures/Monthly correlations - EPI vs HYPO AGU aug.jpg", 
     width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_agu_aug + theme(axis.title.x = element_blank()),
          temp_temp_agu_aug,
          common.legend = T, legend = "bottom",nrow=2, align = "hv")
dev.off()

jpeg("../Figures/Monthly correlations - EPI vs HYPO AGU aug hypo.jpg", 
     width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_agu + theme(axis.title.x = element_blank()),
          temp_temp_agu_aug,
          common.legend = T, legend = "bottom",nrow=2, align = "hv")
dev.off()

jpeg("../Figures/Monthly correlations - EPI vs HYPO AGU spring summer.jpg", 
     width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_agu_spring_summer + 
            theme(axis.title.x = element_blank()) +
            ggtitle("Summer surface-water temperature"),
          temp_temp_agu_spring_summer +
            ggtitle("Summer bottom-water temperature"),
          common.legend = T, legend = "right",nrow=2, align = "hv")
dev.off()

do_temp_agu <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations_talk("DO_mgL_HYPO", "value", "Summer hypo. DO ", 
                            alpha = 0.001, highlight = c(1.5, 4.5))

temp_demand_agu <- monthly_correlations_talk(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "value", 
                                    "Summer VHOD ", alpha = 0.001,
                                    highlight = c(1.5, 4.5))

do_temp_agu_spring_summer <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations_spring_summer("DO_mgL_HYPO", "value", 
                                  "Summer hypo. DO ", alpha = 0.001)

temp_demand_agu_spring_summer <- monthly_correlations_spring_summer(many_lake_temp_sum,
                                  "DO_demand_mgLd_HYPO", "value", 
                                  "oxygen demand", alpha = 0.001)

jpeg("../Figures/Monthly correlations - VHOD and DO AGU.jpg", width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_demand_agu + 
            theme(axis.title.x = element_blank()),
          do_temp_agu,
          common.legend = T, legend = "bottom",nrow=2, align = "hv")
dev.off()

jpeg("../Figures/Monthly correlations - all AGU.jpg", width = 8, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_agu + theme(axis.title.x = element_blank()),
          temp_temp_agu + 
            theme(axis.title.x = element_blank()),
          temp_demand_agu,
          do_temp_agu,
          common.legend = T, legend = "bottom", nrow=2, ncol = 2, align = "h", labels = "auto")
dev.off()

jpeg("../Figures/Monthly correlations - VHOD and DO AGU spring summer.jpg", 
     width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_demand_agu_spring_summer + 
            theme(axis.title.x = element_blank()) +
            ggtitle("Summer bottom-water oxygen demand"),
          do_temp_agu_spring_summer +
            ggtitle("Summer bottom-water dissolved oxygen"),
          common.legend = T, legend = "right",nrow=2, align = "hv")
dev.off()

do_temp_agu_aug <- many_lake_temp_sum %>%
  mutate(hypoxic = ifelse(max(DO_mgL_HYPO, na.rm = T)<1,"yes","no"))%>%
  filter(hypoxic=="no") %>%
  monthly_correlations_talk_aug("DO_mgL_HYPO", "value", "bottom-water DO", alpha = 0.001)

temp_demand_agu_aug <- monthly_correlations_talk_aug(many_lake_temp_sum, 
                                    "DO_demand_mgLd_HYPO", "value", 
                                    "oxygen demand", alpha = 0.001)

jpeg("../Figures/Monthly correlations - VHOD and DO AGU aug.jpg", width = 5, height = 5, res = 300, units = "in")
ggarrange(temp_demand_agu_aug + theme(axis.title.x = element_blank()),
          do_temp_agu_aug,
          common.legend = T, legend = "bottom",nrow=2, align = "hv")
dev.off()

max_depth_comp <- lat_long %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  filter(Region %in% c("Wisconsin", "Northeast"),
         MaximumDepth_m > 6.4) %>%
  ggplot(aes(x = Region, y = MaximumDepth_m))+
  geom_violin(draw_quantiles = c(0.25, 0.75),
              linetype = "dashed") +
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  scale_y_log10()+
  theme_bw()+
  stat_compare_means(label.x.npc = "center", hjust = 0.5)+
  ylab("Maxumum depth (m)")+
  theme(axis.title.x = element_blank())

sa_comp <- lat_long %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  filter(Region %in% c("Wisconsin", "Northeast"),
         MaximumDepth_m > 6.4) %>%
  ggplot(aes(x = Region, y = SurfaceArea_ha))+
  geom_violin(draw_quantiles = c(0.25, 0.75),
              linetype = "dashed") +
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  scale_y_log10()+
  stat_compare_means(label.x.npc = "center", hjust = 0.5)+
  theme_bw()+
  ylab("Surface area (ha)")+
  theme(axis.title.x = element_blank())

jpeg("../Figures/Max depth and surface area by region.jpg", width = 6, height = 4, res = 300, units = "in")
ggarrange(max_depth_comp, sa_comp, nrow = 1)
dev.off()
```

```{r}
library(scales)
with_temp %>%
  mutate(spring_temp = (temp_feb + temp_mar + temp_apr)/3) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            hypo_temp = mean(Temp_C_HYPO, na.rm = T)) %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  ggplot(aes(x = spring_temp, y = hypo_temp, color = Region, size = MaximumDepth_m)) +
  geom_point()+
  geom_smooth(method = "lm")

with_temp %>%
  mutate(spring_temp = (temp_feb + temp_mar + temp_apr)/3) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            hypo_temp = mean(Temp_C_HYPO, na.rm = T)) %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  ggplot(aes(x = MaximumDepth_m, y = hypo_temp, color = spring_temp)) +
  geom_point()+
  scale_x_log10()+
  #geom_smooth(method = "lm")+
  scale_color_viridis_c(option = "B", trans = pseudo_log_trans())

with_temp %>%
  mutate(spring_temp = (temp_feb + temp_mar + temp_apr)/3) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            hypo_temp = mean(Temp_C_HYPO, na.rm = T)) %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  ggplot(aes(x = SurfaceArea_ha, y = hypo_temp, color = spring_temp)) +
  geom_point()+
  scale_x_log10()+
  #geom_smooth(method = "lm")+
  scale_color_viridis_c(option = "B", trans = pseudo_log_trans())

with_temp %>%
  mutate(spring_temp = (temp_feb + temp_mar + temp_apr)/3) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            hypo_temp = mean(Temp_C_HYPO, na.rm = T)) %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other")))) %>%
  ggplot(aes(x = MeanDepth_m, y = hypo_temp, color = spring_temp)) +
  geom_point()+
  scale_x_log10()+
  #geom_smooth(method = "lm")+
  scale_color_viridis_c(option = "B", trans = pseudo_log_trans())

for_lm <- with_temp %>%
  mutate(spring_temp = (temp_feb + temp_mar + temp_apr)/3,
         summer_temp = (temp_july + temp_aug)/2) %>%
  group_by(LakeID) %>%
  summarize(spring_temp = mean(spring_temp, na.rm = T),
            summer_temp = mean(summer_temp, na.rm = T),
            hypo_temp = mean(Temp_C_HYPO, na.rm = T),
            epi_temp = mean(Temp_C_EPI, na.rm = T)) %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Wisconsin",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other"))),
         log_SA = log(SurfaceArea_ha),
         log_max_depth = log(MaximumDepth_m))

source("lmer_functions.R")

responses <- c("hypo_temp")
potential_drivers <- c("spring_temp", 
                       "summer_temp", 
                       "log_SA", 
                       "log_max_depth", 
                       "Latitude_DD"
                      )
aic_calculator_lm(for_lm,responses,potential_drivers, interaction = "+")
selected_drivers <- c("spring_temp", "summer_temp", "log_SA", "log_max_depth", "Latitude_DD")
std_data <-standardize_data(for_lm,responses,selected_drivers)
mod_lm <- lm(hypo_temp~spring_temp + summer_temp + log_SA + log_max_depth + Latitude_DD, data = std_data) 
car::vif(mod_lm)
summary(mod_lm)
hypo_lm <- plot_effects_lm(mod_lm,"Summer hypo. temperature") 

responses <- c("epi_temp")
#same drivers as above
aic_calculator_lm(for_lm,responses,potential_drivers, interaction = "+")
selected_drivers <- c("spring_temp", "summer_temp", "log_SA", "log_max_depth", "Latitude_DD")
std_data <-standardize_data(for_lm,responses,selected_drivers)
mod_lm <- lm(epi_temp~spring_temp + summer_temp + log_SA + log_max_depth + Latitude_DD, data = std_data) 
car::vif(mod_lm)
summary(mod_lm)
epi_lm <- plot_effects_lm(mod_lm,"Summer epi. temperature") 

jpeg("../Figures/lm_hypo_epi.jpeg", width = 7, height = 3, units = "in", res = 300)
ggarrange(hypo_lm + xlim(c(-1,1)), epi_lm + xlim(c(-1,1)))
dev.off()
```


Regions

```{r}
many_lake_temp_sum_region <- 
  many_lake_temp_sum %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Midwest",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", 
                                ifelse(StateOrProvince %in% c("Missouri", "Arkansas", "Oklahoma"),
                                       "Missouri","Other"))))
temp_temp_epi_midwest <- monthly_correlations_talk(many_lake_temp_sum_region %>%
                                                     filter(Region=="Midwest"),
                                  "Temp_C_EPI", "value", 
                                  "Summer epilimnetic temperature (Midwest)", alpha = 0.001,
                                  highlight = c(6.5, 8.5))

temp_temp_epi_northeast <- monthly_correlations_talk(many_lake_temp_sum_region %>%
                                                     filter(Region=="Northeast"),
                                  "Temp_C_EPI", "value", 
                                  "Summer epilimnetic temperature (Northeast)", alpha = 0.001,
                                  highlight = c(6.5, 8.5))

temp_temp_midwest <- monthly_correlations_talk(many_lake_temp_sum_region %>%
                                                     filter(Region=="Midwest"),
                                  "Temp_C_HYPO", "value", 
                                  "Summer hypolimnetic temperature (Midwest)", alpha = 0.001,
                                  highlight = c(1.5, 4.5))

temp_temp_northeast <- monthly_correlations_talk(many_lake_temp_sum_region %>%
                                                     filter(Region=="Northeast"),
                                  "Temp_C_HYPO", "value", 
                                  "Summer hypolimnetic temperature (Northeast)", alpha = 0.001,
                                  highlight = c(1.5, 4.5))

temp_temp_missouri <- monthly_correlations_talk(many_lake_temp_sum_region %>%
                                                     filter(Region=="Missouri"),
                                  "Temp_C_HYPO", "value", 
                                  "Summer hypolimnetic temperature (Missouri)", alpha = 0.001,
                                  highlight = c(1.5, 4.5))

jpeg("../Figures/Monthly correlations - EPI vs HYPO regional.jpg", 
     width = 9, height = 5, res = 300, units = "in")
ggarrange(temp_temp_epi_midwest + 
            theme(axis.title.x = element_blank()),
          temp_temp_epi_northeast + 
            theme(axis.title.x = element_blank()),
          temp_temp_midwest,
          temp_temp_northeast,
          common.legend = T, legend = "bottom", nrow=2, ncol = 2, align = "h")
dev.off()
```

```{r}
library(ggthemes)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
#remotes::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)
library(ggspatial)
library(viridis)
library(ggpubr)

many_lake_stat <- many_lake_temp_sum%>%
  filter(!is.na(Temp_C_HYPO),!is.na(mon), !is.na(value))%>%
  group_by(LakeID, mon)%>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_HYPO, value, Year, method = "spearman")$estimate,
            )

lat_long = read.csv("https://pasta-s.lternet.edu/package/data/eml/edi/1029/9/fadd3eaa25b5fdd1fc4efba70e660579")

to_plot <- many_lake_stat %>%
  filter(mon < 8) %>%
  group_by(LakeID)%>%
  summarize(best_mon = mon[which.max(temp_temp)]) %>%
  left_join(lat_long) 

library(ggridges)

to_plot %>%
  ggplot(aes(x = Latitude_DD, y = best_mon)) +
  geom_point()

to_plot %>%
  mutate(rounded_lat = round(Latitude_DD,0),
         Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Midwest",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), "NE", NA))) %>%
  group_by(rounded_lat, Region) %>%
  mutate(n = n()) %>%
  filter(n > 10,
         Country == "USA",
         !is.na(Region)) %>%
  ggplot(aes(y = as.factor(rounded_lat), x = best_mon)) +
  geom_density_ridges() +
  facet_wrap(~Region)
```

Map

```{r}
for_states <- to_plot
states <- ne_states(returnclass = "sf",country = "United States of America")

us_map = ggplot(data = states) +
  geom_sf() +
  coord_sf(expand = FALSE, ylim = c(42, 47.5), xlim = c(-93,-86.5))+
  geom_point(data = for_states, 
             aes(Longitude_DD, Latitude_DD, fill = as.factor(best_mon)),
             shape = 21, color = "white", size = 2.8, alpha  =.5, stroke = .4)+
  theme_bw()+
  theme(plot.margin = margin(0, 0, 0, 0, "cm"),
    legend.box.background = element_rect(fill = "white", color = "white"))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())+
  geom_hline(yintercept = 44)
us_map
  
us_map = ggplot(data = states) +
  geom_sf() +
  coord_sf(expand = FALSE, ylim = c(42, 47.5), xlim = c(-76,-67)) +
  geom_point(data = for_states, 
             aes(Longitude_DD, Latitude_DD, fill = as.factor(best_mon)),
             shape = 21, color = "white", size = 2.8, alpha  =.5, stroke = .4)+
  theme_bw()+
  theme(plot.margin = margin(0, 0, 0, 0, "cm"),
    legend.box.background = element_rect(fill = "white", color = "white"))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  geom_hline(yintercept = 44)
us_map

world <- ne_countries(scale = "medium", returnclass = "sf")
for_euro <- to_plot

us_map = ggplot(data = world) +
  geom_sf() +
  coord_sf(expand = FALSE, ylim = c(43, 70), xlim = c(-5,30)) +
  geom_point(data = for_euro, 
             aes(Longitude_DD, Latitude_DD, fill = as.factor(best_mon)),
             shape = 21, color = "white", size = 2.8, alpha  =.5, stroke = .4)+
  theme_bw()+
  theme(plot.margin = margin(0, 0, 0, 0, "cm"),
    legend.box.background = element_rect(fill = "white", color = "white"))+
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
us_map
```

OG BF plot
```{r}
temp_temp_data <- many_lake_temp_sum%>%
  group_by(LakeID, mon)%>%
  filter(!is.na(Temp_C_HYPO),!is.na(mon), !is.na(value))%>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_HYPO,value,Year,method = "spearman")$estimate,
            )

summer_avgs = read.csv("../Compiled data/summer_averages_wi.csv")%>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

hypo_temp_temp_data <- temp_temp_data %>% 
  left_join(summer_avgs) %>%
  pivot_wider(names_from = mon, values_from = temp_temp, names_prefix = "Month_")  %>%
  mutate(dif = Month_4 - Month_8)

hypo_temp_temp_data%>%
  ggplot(aes(y = Month_4 - Month_8, x = buoyancy_freq)) +
  geom_hline(yintercept = 0) +
  geom_point() +
  geom_smooth() +
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("eq", "p")), coef.digits = 2) +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp")

library(segmented)
seg_reg <- segmented(lm(dif~buoyancy_freq, data = hypo_temp_temp_data), seg.Z = ~buoyancy_freq)
my.fitted <- fitted(seg_reg)
my.model <- data.frame(buoyancy_freq = hypo_temp_temp_data$buoyancy_freq, dif = my.fitted)

hypo_temp_temp_data%>%
  ggplot(aes(y = Month_4 - Month_8, x = buoyancy_freq)) +
  geom_hline(yintercept = 0) +
  geom_point() +
  geom_line(data = my.model, aes(y = dif, x = buoyancy_freq), color = "blue", lwd=2) +
  geom_vline(xintercept = seg_reg$psi[[2]], color = "blue", lty = "dashed") +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp")

#--- EPI
temp_temp_data <- many_lake_temp_sum%>%
  group_by(LakeID, mon)%>%
  filter(!is.na(Temp_C_EPI),!is.na(mon), !is.na(value))%>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_EPI,value,Year,method = "spearman")$estimate,
            )

summer_avgs = read.csv("../Compiled data/summer_averages_wi.csv")%>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

temp_temp_data %>% 
  left_join(summer_avgs) %>%
  pivot_wider(names_from = mon, values_from = temp_temp, names_prefix = "Month_") %>%
  ggplot(aes(y = Month_4 - Month_8, x = buoyancy_freq)) +
  geom_point() +
  geom_smooth() +
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("eq", "p")), coef.digits = 2) +
  ylab("Relative correlation between epi. temp\nand spring vs summer air temp")
```

BF plot with spring and summer
```{r}
temp_temp_data <- many_lake_temp_sum%>%
  mutate(season = ifelse(mon %in% c(2:4), "Spring",
                         ifelse(mon %in% c(7:8), "Summer", "Neither"))) %>%
  filter(!season == "Neither") %>%
  group_by(LakeID, season, Year)%>%
  mutate(Temp_C_HYPO = mean(Temp_C_HYPO, na.rm = T),
         value = mean(value, na.rm = T)) %>%
  filter(!is.na(Temp_C_HYPO),!is.na(value))%>%
  group_by(LakeID, season) %>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_HYPO,value,Year,method = "spearman")$estimate,
            )

summer_avgs = read.csv("../Compiled data/summer_averages_wi.csv")%>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

temp_temp_sp_su <- temp_temp_data %>% 
  left_join(summer_avgs) %>%
  pivot_wider(names_from = season, values_from = temp_temp) %>%
  mutate(dif = Spring - Summer) %>%
  filter(!is.na(buoyancy_freq))

temp_temp_sp_su %>%
  ggplot(aes(y = Spring - Summer, x = buoyancy_freq)) +
  geom_point() +
  geom_smooth() +
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("eq", "p")), coef.digits = 2) +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp")

library(segmented)
seg_reg <- segmented(lm(dif~buoyancy_freq, data = temp_temp_sp_su), seg.Z = ~buoyancy_freq)
my.fitted <- fitted(seg_reg)
my.model <- data.frame(buoyancy_freq = temp_temp_sp_su$buoyancy_freq, dif = my.fitted)
jpeg("../Figures/temp_temp_sp_su.jpeg", width = 5, height = 4, units = "in", res = 300)
temp_temp_sp_su %>%
  ggplot(aes(y = Spring - Summer, x = buoyancy_freq)) +
  geom_hline(yintercept = 0) +
  geom_point() +
  geom_line(data = my.model, aes(y = dif, x = buoyancy_freq), color = "blue", lwd=2) +
  geom_vline(xintercept = seg_reg$psi[[2]], color = "blue", lty = "dashed") +
  ylab("Memory of spring air temperature") +
  theme_bw() +
  xlab("Median buoyancy frequency at the thermocline (1/s)") +
  annotate("text", x = -0.0009, y = 1.2, label = "More correlated\nwith spring", 
           hjust = 1, lineheight = .9)+
  annotate("text", x = -0.0009, y = -.9, label = "More correlated\nwith summer", hjust = 1,
           lineheight = .9)+
  coord_cartesian(xlim = c(min(temp_temp_sp_su$buoyancy_freq), max(temp_temp_sp_su$buoyancy_freq)),  clip = 'off') +
  theme(plot.margin = unit(c(5.5, 5.5, 5.5, 70), 
                                "pt")) +
  ggtitle("Summer hypo. temperature")
dev.off()

jpeg("../Figures/temp_temp_sp_su_regional.jpeg", width = 6, height = 5, units = "in", res = 300)
temp_temp_sp_su %>%
  left_join(lat_long) %>%
  mutate(Region = ifelse(StateOrProvince %in% c("Wisconsin", "Minnesota", "Michigan"),
                         "Midwest",
                         ifelse(StateOrProvince %in% c("Maine", "New York", "NH", "New Hampshire", "Vermont"), 
                                "Northeast", "Other"))) %>%
  ggplot(aes(y = Spring - Summer, x = buoyancy_freq, color = Region)) +
  geom_hline(yintercept = 0) +
  geom_point() +
  geom_line(data = my.model, aes(y = dif, x = buoyancy_freq), color = "blue", lwd=2) +
  geom_vline(xintercept = seg_reg$psi[[2]], color = "blue", lty = "dashed") +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp") +
  theme_bw() +
  xlab("Median buoyancy frequency at the thermocline (1/s)") +
  annotate("text", x = -0.0009, y = 1.2, label = "More correlated\nwith spring", 
           hjust = 1, lineheight = .9)+
  annotate("text", x = -0.0009, y = -1, label = "More correlated\nwith summer", hjust = 1,
           lineheight = .9)+
  coord_cartesian(xlim = c(min(temp_temp_sp_su$buoyancy_freq), max(temp_temp_sp_su$buoyancy_freq)),  clip = 'off') +
  theme(plot.margin = unit(c(5.5, 5.5, 5.5, 60), 
                                "pt")) 
dev.off()
```

Including unstrat
```{r}
all_inc_unstrat <- read.csv("../Compiled data/summer_averages_wi_surface.csv")
with_temp_unstrat <- all_inc_unstrat %>%
  pivot_wider(names_from = Layer, values_from = TP_ugL:TN_date)
all_climate <- read.csv("../Compiled data/historical_temp_output_era5.csv")

many_lake_temp_sum_all <- all_climate %>%
  rename(mon = Month,
         value = Temp_C) %>%
  mutate(Year = ifelse(mon>=9,Year+1,Year)) %>%
  full_join(with_temp_unstrat)

temp_temp_data <- many_lake_temp_sum_all %>%
  group_by(LakeID, mon)%>%
  filter(!is.na(Temp_C_BOT),!is.na(mon), !is.na(value))%>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_BOT,value,Year,method = "spearman")$estimate,
            )

bf = all_inc_unstrat %>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

temp_temp_data %>% 
  left_join(bf) %>%
  pivot_wider(names_from = mon, values_from = temp_temp, names_prefix = "Month_") %>%
  ggplot(aes(y = Month_4 - Month_8, x = buoyancy_freq)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("eq", "p")), coef.digits = 2) +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp")
```

Including unstrat, seasons
```{r}
all_inc_unstrat <- read.csv("../Compiled data/summer_averages_wi_surface.csv")
with_temp_unstrat <- all_inc_unstrat %>%
  pivot_wider(names_from = Layer, values_from = TP_ugL:TN_date)
all_climate <- read.csv("../Compiled data/historical_temp_output_era5.csv")

many_lake_temp_sum_all <- all_climate %>%
  rename(mon = Month,
         value = Temp_C) %>%
  mutate(Year = ifelse(mon>=9,Year+1,Year)) %>%
  full_join(with_temp_unstrat)

temp_temp_data <- many_lake_temp_sum_all  %>%
  mutate(season = ifelse(mon %in% c(2:4), "Spring",
                         ifelse(mon %in% c(7:8), "Summer", "Neither"))) %>%
  filter(!season == "Neither") %>%
  group_by(LakeID, season, Year) %>%
  mutate(Temp_C_BOT = mean(Temp_C_BOT, na.rm = T)) %>%
  filter(!is.na(Temp_C_BOT), !is.na(mon), !is.na(value))%>%
  group_by(LakeID, season) %>%
  mutate(nyear = length(unique(Year)))%>%
  filter(nyear>=10,
         #max(value)-min(value)>2
         )%>%
  dplyr::summarize(temp_temp = pcor.test(Temp_C_BOT,value,Year,method = "spearman")$estimate,
            )

bf = all_inc_unstrat %>%
  group_by(LakeID) %>%
  summarize(buoyancy_freq = median(buoyancy_freq, na.rm = T))

temp_temp_data %>% 
  left_join(bf) %>%
  pivot_wider(names_from = season, values_from = temp_temp) %>%
  ggplot(aes(y = Spring - Summer, x = buoyancy_freq)) +
  geom_point() +
  geom_smooth() +
  ggpmisc::stat_poly_eq(ggpmisc::use_label(c("eq", "p")), coef.digits = 2) +
  ylab("Relative correlation between hypo. temp\nand spring vs summer air temp")
```
